<?xml version="1.0" encoding="UTF-8"  ?>
<!-- Created with iReport - A designer for JasperReports -->
<!DOCTYPE jasperReport PUBLIC "//JasperReports//DTD Report Design//EN" "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">
<jasperReport
		 name="LoanInvoice_subreport"
		 columnCount="1"
		 printOrder="Vertical"
		 orientation="Portrait"
		 pageWidth="782"
		 pageHeight="555"
		 columnWidth="782"
		 columnSpacing="0"
		 leftMargin="0"
		 rightMargin="0"
		 topMargin="0"
		 bottomMargin="0"
		 whenNoDataType="NoPages"
		 scriptletClass="edu.harvard.huh.specify.config.HUHScriptlet"
		 isTitleNewPage="false"
		 isSummaryNewPage="false">
		 
	<property name="ireport.scriptlethandling" value="0" />
	<property name="ireport.encoding" value="UTF-8" />
	<import value="java.util.*" />
	<import value="net.sf.jasperreports.engine.*" />
	<import value="net.sf.jasperreports.engine.data.*" />

	<parameter name="itemnum" isForPrompting="false" class="java.lang.Long"/>
	<parameter name="SUBREPORT_DIR" isForPrompting="false" class="java.lang.String"/>
	
	<queryString><![CDATA[select
       loan.CurrentDueDate    as currentDueDate,
       loan.LoanDate          as loanDate,
       loan.LoanID            as loanID,
       loan.LoanNumber        as loanNumber,
       loan.PurposeOfLoan     as purpose,
       loan.SpecialConditions as specialConditions,
       loan.Text1             as forUseByText,
       loan.Text2             as herbarium,

       (select Title from picklistitem where Value=borrower.Title and PickListID=
         (select PickListID from picklist where Name="AgentTitles")) as borrowerTitle,
         
       borrower.FirstName   as borrowerFirstName,
       borrower.Initials    as borrowerMiddleInitial,
       borrower.LastName    as borrowerLastName,
       borrower.JobTitle    as borrowerJobTitle,

       (select Title from picklistitem where Value=forUseBy.Title and PickListID=
         (select PickListID from picklist where Name="AgentTitles")) as forUseByTitle,
         
       forUseBy.FirstName as forUseByFirstName,
       forUseBy.Initials  as forUseByMiddleInitial,
       forUseBy.LastName  as forUseByLastName,
       forUseBy.JobTitle  as forUseByJobTitle

from shipment
     left join loan on shipment.LoanID=loan.LoanID
     left join (select * from loanagent where Role="Borrower") borroweragent on loan.LoanID=borroweragent.LoanID
     left join agent borrower on borroweragent.AgentID=borrower.AgentID
     left join (select * from loanagent where Role="ForUseBy") forusebyagent on loan.LoanID=forusebyagent.LoanID
     left join agent forUseBy on forusebyagent.AgentID=forUseBy.AgentID

where shipment.ShipmentID $P!{itemnum}]]></queryString>

	<field name="borrowerFirstName"     class="java.lang.String"/>
	<field name="borrowerJobTitle"      class="java.lang.String"/>
	<field name="borrowerLastName"      class="java.lang.String"/>
	<field name="borrowerMiddleInitial" class="java.lang.String"/>
	<field name="borrowerTitle"         class="java.lang.String"/>
	<field name="currentDueDate"        class="java.sql.Date"/>
	<field name="forUseByText"          class="java.lang.String"/>
	<field name="forUseByFirstName"     class="java.lang.String"/>
	<field name="forUseByJobTitle"      class="java.lang.String"/>
	<field name="forUseByLastName"      class="java.lang.String"/>
	<field name="forUseByMiddleInitial" class="java.lang.String"/>
	<field name="forUseByTitle"         class="java.lang.String"/>
	<field name="herbarium"             class="java.lang.String"/>
	<field name="loanID"                class="java.lang.Long"/>
	<field name="loanDate"              class="java.sql.Date"/>
	<field name="loanNumber"            class="java.lang.String"/>
	<field name="purpose"               class="java.lang.String"/>
	<field name="specialConditions"     class="java.lang.String"/>
	
	<variable name="items" class="java.lang.Integer" resetType="Report" calculation="Sum">
	</variable>
	<variable name="nonSpecimens" class="java.lang.Integer" resetType="Report" calculation="Sum">
	</variable>
	<variable name="types" class="java.lang.Integer" resetType="Report" calculation="Sum">
	</variable>
	
	<background>
		<band isSplitAllowed="true"/>
	</background>
	<title>
		<band isSplitAllowed="true"/>
	</title>
	<pageHeader>
		<band isSplitAllowed="true"/>
	</pageHeader>
	<columnHeader>
		<band height="157" isSplitAllowed="true">
			<rectangle>
				<reportElement mode="Transparent" x="419" y="4" width="263" height="101"/>
			</rectangle>
			<staticText>
				<reportElement key="staticText-9" mode="Transparent" x="431" y="11" width="113" height="15" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Serif" size="12" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<text><![CDATA[Term of loan:]]></text>
			</staticText>
			<staticText>
				<reportElement x="444" y="26" width="100" height="20"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Loan due date:]]></text>
			</staticText>
			<staticText>
				<reportElement x="431" y="46" width="238" height="27"/>
				<textElement>
					<font fontName="Serif" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Email: jmacklin@oeb.harvard.edu; HUHrequests@oeb.harvard.edu]]></text>
			</staticText>
			<staticText>
				<reportElement x="431" y="72" width="238" height="27"/>
				<textElement>
					<font fontName="Serif" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Requests for loan extensions should be made to Dr. James Macklin and/or HUHrequests]]></text>
			</staticText>
			<textField pattern="yyyy/MM/dd" isBlankWhenNull="false">
				<reportElement key="textField" x="544" y="26" width="110" height="18"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement>
					<font size="12" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[$F{currentDueDate}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="false">
				<reportElement key="textField-3" x="544" y="10" width="97" height="15"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[((edu.harvard.huh.specify.config.HUHScriptlet)$P{REPORT_SCRIPTLET}).dateDifference($F{loanDate}, $F{currentDueDate})]]></textFieldExpression>
			</textField>
			<rectangle>
				<reportElement mode="Transparent" x="9" y="15" width="186" height="51"/>
			</rectangle>
			<textField isBlankWhenNull="false">
				<reportElement key="textField" x="101" y="15" width="95" height="20"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement>
					<font size="14" isBold="true" isUnderline="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{loanNumber}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="9" y="15" width="92" height="19"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Loan Number: ]]></text>
			</staticText>
			<staticText>
				<reportElement x="9" y="73" width="28" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[To: ]]></text>
			</staticText>
			<textField isBlankWhenNull="false">
				<reportElement key="textField" x="44" y="78" width="152" height="13"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[((edu.harvard.huh.specify.config.HUHScriptlet)$P{REPORT_SCRIPTLET}).buildNameString($F{borrowerTitle}, $F{borrowerFirstName}, $F{borrowerLastName}, $F{borrowerMiddleInitial})]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="9" y="139" width="34" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Coll.:]]></text>
			</staticText>
			<staticText>
				<reportElement x="64" y="139" width="67" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Barcode:]]></text>
			</staticText>
			<staticText>
				<reportElement x="168" y="139" width="48" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Taxon:]]></text>
			</staticText>
			<staticText>
				<reportElement x="293" y="139" width="46" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Items:]]></text>
			</staticText>
			<staticText>
				<reportElement x="352" y="123" width="67" height="34"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Non-specimens:]]></text>
			</staticText>
			<staticText>
				<reportElement x="431" y="139" width="51" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Types:]]></text>
			</staticText>
			<staticText>
				<reportElement x="505" y="139" width="84" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Description:]]></text>
			</staticText>
			<staticText>
				<reportElement x="9" y="99" width="77" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[For use by:]]></text>
			</staticText>
			<textField isBlankWhenNull="false">
				<reportElement key="textField" x="86" y="104" width="152" height="13"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[((edu.harvard.huh.specify.config.HUHScriptlet)$P{REPORT_SCRIPTLET}).buildNameString($F{forUseByText}, $F{forUseByTitle}, $F{forUseByFirstName}, $F{forUseByLastName}, $F{forUseByMiddleInitial})]]></textFieldExpression>
			</textField>
		</band>
	</columnHeader>
	<detail>
		<band height="177" isSplitAllowed="true">
				<subreport  isUsingCache="true">
					<reportElement
						x="1"
						y="1"
						width="549"
						height="98"
						key="subreport-1"/>
					<subreportParameter  name="itemnum">
						<subreportParameterExpression><![CDATA[$F{loanID}]]></subreportParameterExpression>
					</subreportParameter>
					<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
					<returnValue subreportVariable="itemCount" toVariable="items"/>
					<returnValue subreportVariable="nonSpecimenCount" toVariable="nonSpecimens"/>
					<returnValue subreportVariable="typeCount" toVariable="types"/>
					<subreportExpression  class="java.lang.String"><![CDATA[$P{SUBREPORT_DIR} + "botany_LoanPrep_subreport.jasper"]]></subreportExpression>
				</subreport>
		</band>
	</detail>
	<columnFooter>
		<band isSplitAllowed="true"/>
	</columnFooter>
	<pageFooter>
		<band isSplitAllowed="true"/>
	</pageFooter>
	<summary>
		<band isSplitAllowed="true"/>
	</summary>
</jasperReport>
