<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE jasperReport PUBLIC "//JasperReports//DTD Report Design//EN" "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">
<jasperReport
		 name="botany_LoanInvoice_subreport"
		 columnCount="1"
		 printOrder="Vertical"
		 orientation="Portrait"
		 pageWidth="612"
		 pageHeight="792"
		 columnWidth="576"
		 columnSpacing="0"
		 leftMargin="0"
		 rightMargin="0"
		 topMargin="0"
		 bottomMargin="0"
		 whenNoDataType="NoPages"
		 scriptletClass="edu.harvard.huh.specify.config.HUHScriptlet"
		 isTitleNewPage="false"
		 isSummaryNewPage="false">
	<property name="ireport.scriptlethandling" value="0"/>
	<property name="ireport.encoding" value="UTF-8"/>
	<import value="java.util.*"/>
	<import value="net.sf.jasperreports.engine.*"/>
	<import value="net.sf.jasperreports.engine.data.*"/>
	<parameter name="itemnum" class="java.lang.Long" isForPrompting="false"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false"/>
	<queryString>
		<![CDATA[select
       loan.CurrentDueDate    as currentDueDate,
       loan.LoanDate          as loanDate,
       loan.LoanID            as loanID,
       loan.LoanNumber        as loanNumber,
       loan.PurposeOfLoan     as purpose,
       loan.SpecialConditions as specialConditions,
       loan.Text1             as forUseByText,
       loan.Text2             as herbarium,

       (select Title from picklistitem where Value=borrower.Title and PickListID=
         (select PickListID from picklist where Name="AgentTitles")) as borrowerTitle,

       borrower.FirstName   as borrowerFirstName,
       borrower.Initials    as borrowerMiddleInitial,
       borrower.LastName    as borrowerLastName,
       borrower.JobTitle    as borrowerJobTitle,

       (select Title from picklistitem where Value=forUseBy.Title and PickListID=
         (select PickListID from picklist where Name="AgentTitles")) as forUseByTitle,

       forUseBy.FirstName as forUseByFirstName,
       forUseBy.Initials  as forUseByMiddleInitial,
       forUseBy.LastName  as forUseByLastName,
       forUseBy.JobTitle  as forUseByJobTitle

from loan
     left join (select * from loanagent where Role="Borrower") borroweragent on loan.LoanID=borroweragent.LoanID
     left join agent borrower on borroweragent.AgentID=borrower.AgentID
     left join (select * from loanagent where Role="ForUseBy") forusebyagent on loan.LoanID=forusebyagent.LoanID
     left join agent forUseBy on forusebyagent.AgentID=forUseBy.AgentID

where loan.LoanID = $P!{itemnum}]]>
	</queryString>
	<field name="borrowerFirstName" class="java.lang.String"/>
	<field name="borrowerJobTitle" class="java.lang.String"/>
	<field name="borrowerLastName" class="java.lang.String"/>
	<field name="borrowerMiddleInitial" class="java.lang.String"/>
	<field name="borrowerTitle" class="java.lang.String"/>
	<field name="currentDueDate" class="java.sql.Date"/>
	<field name="forUseByText" class="java.lang.String"/>
	<field name="forUseByFirstName" class="java.lang.String"/>
	<field name="forUseByJobTitle" class="java.lang.String"/>
	<field name="forUseByLastName" class="java.lang.String"/>
	<field name="forUseByMiddleInitial" class="java.lang.String"/>
	<field name="forUseByTitle" class="java.lang.String"/>
	<field name="herbarium" class="java.lang.String"/>
	<field name="loanID" class="java.lang.Long"/>
	<field name="loanDate" class="java.sql.Date"/>
	<field name="loanNumber" class="java.lang.String"/>
	<field name="purpose" class="java.lang.String"/>
	<field name="specialConditions" class="java.lang.String"/>
	<variable name="items" class="java.lang.Integer" calculation="Sum"/>
	<variable name="nonSpecimens" class="java.lang.Integer" calculation="Sum"/>
	<variable name="types" class="java.lang.Integer" calculation="Sum"/>
	<background>
		<band isSplitAllowed="true"/>
	</background>
	<title>
		<band isSplitAllowed="true"/>
	</title>
	<pageHeader>
		<band isSplitAllowed="true"/>
	</pageHeader>
	<columnHeader>
		<band height="105" isSplitAllowed="true">
			<textField pattern="yyyy/MM/dd" isBlankWhenNull="false">
				<reportElement key="textField" x="450" y="36" width="110" height="18"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement>
					<font size="10" isBold="false" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[$F{currentDueDate}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="false">
				<reportElement key="textField-3" x="447" y="24" width="97" height="15"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[((edu.harvard.huh.specify.config.HUHScriptlet)$P{REPORT_SCRIPTLET}).dateDifference($F{loanDate}, $F{currentDueDate})]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="false">
				<reportElement key="textField" x="74" y="41" width="152" height="13"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[((edu.harvard.huh.specify.config.HUHScriptlet)$P{REPORT_SCRIPTLET}).buildNameString($F{forUseByText}, $F{forUseByTitle}, $F{forUseByFirstName}, $F{forUseByLastName}, $F{forUseByMiddleInitial})]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="10" y="39" width="82" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[For use by:]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-9" mode="Transparent" x="324" y="22" width="118" height="15" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Serif" size="12" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<text><![CDATA[Term of loan:]]></text>
			</staticText>
			<staticText>
				<reportElement x="10" y="22" width="33" height="18"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[To: ]]></text>
			</staticText>
			<staticText>
				<reportElement x="367" y="36" width="106" height="20"/>
				<textElement>
					<font fontName="Serif" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Loan due date:]]></text>
			</staticText>
			<line>
				<reportElement key="line-5" x="10" y="99" width="567" height="2"/>
				<graphicElement>
					<pen lineWidth="0.5" lineStyle="Solid"/>
				</graphicElement>
			</line>
			<staticText>
				<reportElement x="11" y="81" width="567" height="18"/>
				<textElement>
					<font fontName="SansSerif" size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[Acc#     Coll.   Taxon                        Comments                                                             Gen    Non-Spec   Types                  Received   ]]></text>
			</staticText>
			<line>
				<reportElement key="line-5" x="10" y="77" width="567" height="2"/>
				<graphicElement>
					<pen lineWidth="0.5" lineStyle="Solid"/>
				</graphicElement>
			</line>
		</band>
	</columnHeader>
	<detail>
		<band height="99" isSplitAllowed="true">
			<subreport isUsingCache="true">
				<reportElement key="subreport-1" x="3" y="1" width="518" height="64"/>
				<subreportParameter name="itemnum">
					<subreportParameterExpression><![CDATA[$F{loanID}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<returnValue subreportVariable="itemCount" toVariable="items"/>
				<returnValue subreportVariable="nonSpecimenCount" toVariable="nonSpecimens"/>
				<returnValue subreportVariable="typeCount" toVariable="types"/>
				<subreportExpression class="java.lang.String"><![CDATA[$P{SUBREPORT_DIR} + "botany_LoanPrep_subreport.jasper"]]></subreportExpression>
			</subreport>
			<line>
				<reportElement key="line-5" x="11" y="72" width="567" height="2"/>
				<graphicElement>
					<pen lineWidth="0.5" lineStyle="Solid"/>
				</graphicElement>
			</line>
		</band>
	</detail>
	<columnFooter>
		<band isSplitAllowed="true"/>
	</columnFooter>
	<pageFooter>
		<band isSplitAllowed="true"/>
	</pageFooter>
	<summary>
		<band isSplitAllowed="true"/>
	</summary>
</jasperReport>
