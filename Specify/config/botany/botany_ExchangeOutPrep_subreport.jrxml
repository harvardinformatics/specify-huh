<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE jasperReport PUBLIC "//JasperReports//DTD Report Design//EN" "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">
<jasperReport
		 name="botany_ExchangeOutPrep_subreport"
		 columnCount="1"
		 printOrder="Vertical"
		 orientation="Portrait"
		 pageWidth="612"
		 pageHeight="792"
		 columnWidth="576"
		 columnSpacing="0"
		 leftMargin="0"
		 rightMargin="0"
		 topMargin="0"
		 bottomMargin="0"
		 whenNoDataType="NoPages"
		 scriptletClass="edu.harvard.huh.specify.config.HUHScriptlet"
		 isTitleNewPage="false"
		 isSummaryNewPage="false">
	<property name="ireport.scriptlethandling" value="0"/>
	<property name="ireport.encoding" value="UTF-8"/>
	<import value="java.util.*"/>
	<import value="net.sf.jasperreports.engine.*"/>
	<import value="net.sf.jasperreports.engine.data.*"/>
	<parameter name="itemnum" class="java.lang.Long" isForPrompting="false"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false"/>
	<queryString>
		<![CDATA[select
       if (exchangeoutprep.PreparationID is null, exchangeout.Text2, prepattr.Text3) as herbarium,

       prep.SampleNumber    as barcode,
       family.FullName      as higherTaxon,

       if (exchangeoutprep.PreparationID is null,
           exchangeoutprep.Quantity - exchangeoutprep.TypeCount - exchangeoutprep.NonSpecimenCount,
           if(types.CollectionObjectID is null, 1, 0)
          ) as items,

       if(exchangeoutprep.NonSpecimenCount is null, 0, exchangeoutprep.NonSpecimenCount) as nonSpecimens,

       if (exchangeoutprep.PreparationID is null,
           exchangeoutprep.TypeCount,
           if(types.CollectionObjectID is null, 0, 1)
          ) as types,

       exchangeoutprep.DescriptionOfMaterial as description

     from exchangeout
     left join exchangeoutpreparation exchangeoutprep on exchangeout.ExchangeOutID=exchangeoutprep.ExchangeOutID
     left join preparation prep on exchangeoutprep.PreparationID=prep.PreparationID
     left join preparationattribute prepattr on prep.PreparationAttributeID=prepattr.PreparationAttributeID
     left join (select distinct CollectionObjectID from determination where TypeStatusName is not null) types on prep.CollectionObjectID=types.CollectionObjectID
     left join (select distinct f.FullName, d.CollectionObjectID from taxon f, taxon t, determination d
                where d.TaxonID=t.taxonID and f.RankID=140 and f.NodeNumber < t.NodeNumber and t.NodeNumber <= f.HighestChildNodeNumber) family on family.CollectionObjectID=prep.CollectionObjectID

    where exchangeout.ExchangeOutID = $P!{itemnum} order by description, barcode]]>
	</queryString>
	<field name="barcode" class="java.lang.String"/>
	<field name="description" class="java.lang.String"/>
	<field name="herbarium" class="java.lang.String"/>
	<field name="higherTaxon" class="java.lang.String"/>
	<field name="items" class="java.lang.Integer"/>
	<field name="nonSpecimens" class="java.lang.Integer"/>
	<field name="types" class="java.lang.Integer"/>
	<variable name="itemCount" class="java.lang.Integer" incrementType="Report">
		<variableExpression><![CDATA[new Integer($F{items}.intValue())]]></variableExpression>
		<initialValueExpression><![CDATA[new Integer(0)]]></initialValueExpression>
	</variable>
	<variable name="nonSpecimenCount" class="java.lang.Integer">
		<variableExpression><![CDATA[new java.lang.Integer(  $F{nonSpecimens}.intValue() )]]></variableExpression>
		<initialValueExpression><![CDATA[new Integer(0)]]></initialValueExpression>
	</variable>
	<variable name="typeCount" class="java.lang.Integer">
		<variableExpression><![CDATA[new Integer ( $F{types}.intValue() )]]></variableExpression>
	</variable>
	<background>
		<band isSplitAllowed="true"/>
	</background>
	<detail>
		<band height="94" isSplitAllowed="true">
			<textField isBlankWhenNull="true">
				<reportElement x="491" y="1" width="51" height="20"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{types}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="42" y="1" width="48" height="20"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{higherTaxon}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="64" y="1" width="53" height="20"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{higherTaxon}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="425" y="1" width="46" height="20"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{items}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="457" y="1" width="67" height="20"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{nonSpecimens}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="10" y="1" width="45" height="20"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{herbarium}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement x="136" y="1" width="231" height="60"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{description}]]></textFieldExpression>
			</textField>
			<rectangle>
				<reportElement x="542" y="1" width="15" height="15"/>
			</rectangle>
		</band>
	</detail>
</jasperReport>
